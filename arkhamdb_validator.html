<body>
  <textarea id="deckList">
493723
479501
489153
493047
  </textarea>
  <button id="submit"> Check! </button>
  <div class="output">
    <div> Last DeckIDs
      <ul id="lastDeckIDs"> </ul>
    </div>
    <div> Cards with total count > 2:
      <ul id="cardCountOut"> </ul>
    </div>
  </div>
</body>

<script>
async function getDeck(deckID) {
  return fetch(`https://arkhamdb.com/api/public/deck/${deckID}.json`)
    .then(r => r.json())
}

async function getAllDecks(deckIDs) {
  return Promise.all(deckIDs.map(async deckID => {
    let d = null;
    while (d === null || d.next_deck !== null) {
      d = await getDeck(d ? d.next_deck : deckID);
    }
    return d;
  }));
}

async function main() {
  function resolveCard(cardID) {
    const card = cards.find(c => c.code === cardID);
    return card ? card.name : "Unknown";
  }

  const cards = await fetch("https://arkhamdb.com/api/public/cards/")
    .then(r => r.json());

  // const deckIDs = ['496803', '499642', '526251']
  // const deckIDs = ['493723', '479501', '489153', '493047'];
  const deckIDs = document.querySelector('#deckList').value.trim().split('\n')
    .map(deckID => deckID.split('/').pop());
  decks = [...(await getAllDecks(deckIDs))]

  let cardCounts =
    decks.map(deck => Object.entries(deck.slots))
      .reduce((acc, deck) => {
        deck.map(([cardID, count]) => {
          acc[cardID] = parseInt(count) + (acc[cardID] ? acc[cardID] : 0);
        });
        return acc;
      }, {});

  const cardCountOut = document.querySelector('#cardCountOut');
  cardCountOut.innerHTML = '';

  Object.entries(cardCounts)
    .filter(([cardID, count]) => count > 2)
    .forEach(([cardID, count]) => {
      const item = cardCountOut.appendChild(document.createElement('li'));
      item.textContent = `${resolveCard(cardID)}: ${count}`
    });

  const lastDeckIDs = document.querySelector('#lastDeckIDs');
  lastDeckIDs.innerHTML = '';

  decks.forEach(deck => {
    link = lastDeckIDs.appendChild(document.createElement('a'));
    link.href = 'https://arkhamdb.com/deck/view/' + deck.id;
    link.textContent = 'https://arkhamdb.com/deck/view/' + deck.id;
  })
}

document.querySelector('#submit').addEventListener('click', main);
</script>

<style>
#deckList {
  display: block;
  width: 70ex;
  height: 10em;
}

.output > * {
  margin-bottom: 1em;
}

#lastDeckIDs a {
  display: list-item;
}
</style>
